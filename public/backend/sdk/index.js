(()=>{function e(e){alert("Uncaught exception. See console logs for more details.")}self.addEventListener("error",e),self.addEventListener("unhandledrejection",e),window.pvtsutils=Object,window.pvtsutils.Convert=Object,window.pvtsutils.PrepareBuffer=e=>"undefined"!=typeof Buffer?new Uint8Array(e):new Uint8Array(e instanceof ArrayBuffer?e:e.buffer),window.pvtsutils.Convert.ToString=(e,t)=>{void 0===t&&(t="utf8");var r=window.pvtsutils.PrepareBuffer(e);switch(t.toLowerCase()){case"utf8":return window.pvtsutils.Convert.ToUtf8String(r);case"binary":return window.pvtsutils.Convert.ToBinary(r);case"hex":return window.pvtsutils.Convert.ToHex(r);case"base64":return window.pvtsutils.Convert.ToBase64(r);case"base64url":return window.pvtsutils.Convert.ToBase64Url(r);default:throw new Error("Unknown type of encoding '"+t+"'")}},window.pvtsutils.Convert.FromString=(e,t)=>{switch(void 0===t&&(t="utf8"),t.toLowerCase()){case"utf8":return window.pvtsutils.Convert.FromUtf8String(e);case"binary":return window.pvtsutils.Convert.FromBinary(e);case"hex":return window.pvtsutils.Convert.FromHex(e);case"base64":return window.pvtsutils.Convert.FromBase64(e);case"base64url":return window.pvtsutils.Convert.FromBase64Url(e);default:throw new Error("Unknown type of encoding '"+t+"'")}},window.pvtsutils.Convert.ToBase64=e=>{var t=window.pvtsutils.PrepareBuffer(e);if("undefined"!=typeof btoa){var r=window.pvtsutils.Convert.ToString(t,"binary");return btoa(r)}return new Buffer(t).toString("base64")},window.pvtsutils.Convert.FromBase64=function(e){return e=e.replace(/\n/g,"").replace(/\r/g,"").replace(/\t/g,"").replace(/\s/g,""),"undefined"!=typeof atob?window.pvtsutils.Convert.FromBinary(atob(e)):new Uint8Array(new Buffer(e,"base64")).buffer},window.pvtsutils.Convert.FromBase64Url=function(e){return window.pvtsutils.Convert.FromBase64(window.pvtsutils.Convert.Base64Padding(e.replace(/\-/g,"+").replace(/\_/g,"/")))},window.pvtsutils.Convert.ToBase64Url=function(e){return window.pvtsutils.Convert.ToBase64(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,"")},window.pvtsutils.Convert.FromUtf8String=function(e){for(var t=unescape(encodeURIComponent(e)),r=new Uint8Array(t.length),o=0;o<t.length;o++)r[o]=t.charCodeAt(o);return r.buffer},window.pvtsutils.Convert.ToUtf8String=function(e){var t=window.pvtsutils.PrepareBuffer(e),r=String.fromCharCode.apply(null,t);return decodeURIComponent(escape(r))},window.pvtsutils.Convert.FromBinary=function(e){for(var t=e.length,r=new Uint8Array(t),o=0;o<t;o++)r[o]=e.charCodeAt(o);return r.buffer},window.pvtsutils.Convert.ToBinary=function(e){for(var t=window.pvtsutils.PrepareBuffer(e),r="",o=t.length,n=0;n<o;n++)r+=String.fromCharCode(t[n]);return r},window.pvtsutils.Convert.ToHex=function(e){for(var t=window.pvtsutils.PrepareBuffer(e),r=[],o=t.length,n=0;n<o;n++){var i=t[n].toString(16);r.push(1===i.length?"0"+i:i)}return r.join("")},window.pvtsutils.Convert.FromHex=function(e){for(var t=new Uint8Array(e.length/2),r=0;r<e.length;r+=2){var o=e.slice(r,r+2);t[r/2]=parseInt(o,16)}return t.buffer},window.pvtsutils.Convert.Base64Padding=function(e){var t=4-e.length%4;if(t<4)for(var r=0;r<t;r++)e+="=";return e},window.pvtsutils.combine=()=>{for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var r=e.map((function(e){return e.byteLength})).reduce((function(e,t){return e+t})),o=new Uint8Array(r),n=0;return e.map((function(e){return new Uint8Array(e)})).forEach((function(e){for(var t=0;t<e.length;t++)o[n++]=e[t]})),o.buffer},window.pvtsutils.isEqual=(e,t)=>{if(!e||!t)return!1;if(e.byteLength!==t.byteLength)return!1;for(var r=new Uint8Array(e),o=new Uint8Array(t),n=0;n<e.byteLength;n++)if(r[n]!==o[n])return!1;return!0},window.selector=e=>{const t=document.getElementById(e);if(!t)throw new Error("Cannot get element by id '"+e+"'");return t},window.FillProviderSelect=async e=>{e.innerHTML="";const t=await ws.info();let r=!1;if(t.providers=t.providers.filter((e=>!provider.isHardware)),!t.providers.length){const t=document.createElement("option");t.textContent="No providers",t.setAttribute("value",""),t.setAttribute("disabled",!0),t.setAttribute("selected",!0),e.appendChild(t)}for(const o of t.providers)if(o.isHardware){const t=document.createElement("option");t.setAttribute("value",o.id),t.textContent=`${o.name} ${o._token._label}`,r||(t.setAttribute("selected",!0),r=!0),e.appendChild(t)}},window.fillCertificateSelect=async(e,t)=>{await e.isLoggedIn()||await e.login();let r=await e.certStorage.keys();r=r.filter((e=>"x509"===e.split("-")[0]));let o=await e.keyStorage.keys();o=o.filter((function(e){return"private"===e.split("-")[0]}));const n=[];for(const t of r)for(const r of o)if(r.split("-")[2]===t.split("-")[2])try{const r=await e.certStorage.getItem(t);n.push({id:t,item:r})}catch(e){console.error(`Cannot get certificate ${t} from CertificateStorage. ${e.message}`)}t.textContent="",n.map((e=>({id:e.id,name:GetCommonName(e.item.subjectName)}))).sort(((e,t)=>e.name.toLowerCase()>t.name.toLowerCase()?1:e.name.toLowerCase()<t.name.toLowerCase()?-1:0)).forEach(((e,r)=>{const o=document.createElement("option");o.setAttribute("value",e.id),o.textContent=e.name,r||o.setAttribute("selected",!0),t.appendChild(o)}))},window.DerToPem=(e,t)=>{let r=window.pvtsutils.Convert.ToBase64(e);const o=[];for(o.push("-----BEGIN "+t.toUpperCase()+"-----");r.length>64;)o.push(r.substr(0,64)),r=r.substr(64);return o.push(r),o.push("-----END "+t.toUpperCase()+"-----"),o.join("\r\n")},window.PemToDer=e=>{var t=e.replace(/-----([\w\d\s]+)-----/gi,"").replace(/\n/g,"").replace(/\r/g,"");return window.pvtsutils.Convert.FromBase64(t)},window.GetCommonName=e=>{var t=/CN=(.+),?/i.exec(e);return t?t[1]:"Unknown"},window.arrayBufferToBase64=e=>{for(var t="",r=new Uint8Array(e),o=r.byteLength,n=0;n<o;n++)t+=String.fromCharCode(r[n]);return btoa(t)},window.GetCertificateKey=async(e,t,r)=>{const o=await t.keyStorage.keys();for(const n of o){const o=n.split("-");if(o[0]===e&&o[2]===r.split("-")[2]){const e=await t.keyStorage.getItem(n);if(e)return e}}if("public"===e){const e=await t.certStorage.getItem(r);if(e)return e.publicKey}return null},window.fixDN=e=>{if(e.typesAndValues){const t=new asn1js.Sequence({value:e.typesAndValues.map((function(e){return new asn1js.Set({value:[e.toSchema()]})}))}).toBER();e.fromSchema(asn1js.fromBER(t).result)}},window.generateFileName=(e,t,r)=>`${document.querySelector(`#${e}`).value.split(/(\\|\/)/g).pop().split(".")[0]}_${t}.${r}`,window.setError=e=>{document.querySelector("#error > p").innerHTML=e,setTimeout((()=>{document.querySelector("#error > p").innerHTML=""}),5e3)},window.validatePdfSignForm=()=>""==document.signForm.provider.value?(setError("Please select provider."),!1):""==document.signForm.certificate.value?(setError("Please select certificate."),!1):""==document.signForm.reason.value?(setError("Please add signing reason."),!1):""==document.signForm.reason.value?(document.signForm.reason.focus(),setError("Please add signing reason."),!1):""==document.signForm.location.value?(document.signForm.location.focus(),setError("Please add signing location."),!1):""!=document.signForm.file.value||(setError("Please select file to be signed."),!1),window.validateOfficeSignForm=()=>""==document.signOfficeForm.provider.value?(setError("Please select provider."),!1):""==document.signOfficeForm.certificate.value?(setError("Please select certificate."),!1):""!=document.signOfficeForm.file.value||(setError("Please select file to be signed."),!1),window.signFileForm=()=>""==document.signFileForm.provider.value?(setError("Please select provider."),!1):""==document.signFileForm.certificate.value?(setError("Please select certificate."),!1):""!=document.signFileForm.file.value||(setError("Please select file to be signed."),!1),window.validateFileForm=()=>""==document.validateFileForm.file.value?(setError("Please select the original file."),!1):""!=document.validateFileForm.p7s.value||(setError("Please select .p7s file."),!1),window.validateCertificateForm=()=>""==document.validateCertificateForm.provider.value?(setError("Please select provider."),!1):""!=document.validateCertificateForm.certificate.value||(setError("Please select certificate."),!1),window.validateSignDataForm=()=>""==document.signDataForm.provider.value?(setError("Please select provider."),!1):""==document.signDataForm.certificate.value?(setError("Please select certificate."),!1):""!=document.signDataForm.data.value||(setError("Please add data to be signed."),!1),window.validateValidateDataForm=()=>""==document.validateDataForm.data.value?(setError("Please add data to be validated."),!1):""==document.validateDataForm.signature.value?(setError("Please add the signature."),!1):""!=document.validateDataForm.signerCertificate.value||(setError("Please add signer certificate."),!1),window.validateTimestampForm=()=>""!=document.timestampForm.file.value||(setError("Please select file to be timestamped."),!1),window.validateValidationForm=()=>""!=document.validationForm.file.value||(setError("Please select file to be validated."),!1),window.updateProvider=async()=>{const e=selector("provider");e.innerHTML="",await FillProviderSelectEx(e)},window.FillProviderSelectEx=async e=>{await FillProviderSelect(e),selector("certificate").innerHTML="",await FillItems(e.value)},window.FillItems=async e=>{if(!e)return;const t=await ws.getCrypto(e);await t.isLoggedIn()||await t.login();let r=!1,o=await t.certStorage.keys();const n=selector("certificate");n.innerHTML="";for(const s of o)try{const o=await t.certStorage.getItem(s),l=document.createElement("option"),c=await ws.getCrypto(e);let d=await c.certStorage.getItem(s);var i=await c.certStorage.exportCert("raw",d),a=window.pvtsutils.Convert.ToBase64(i);l.setAttribute("value",a),l.textContent=GetCommonName(o.subjectName),r||(l.setAttribute("selected",!0),r=!0,selector("certLabel").value=GetCommonName(o.subjectName)),n.appendChild(l)}catch(e){setError(`Cannot get ${s} from CertificateStorage.`)}},window.certCleanUp=e=>e.value.replace(new RegExp("; ","g"),"<br />").replace(new RegExp("\n","g"),"<br />").replace(new RegExp('"',"g"),""),window.certCleanUpTs=e=>e.replace(new RegExp("; ","g"),"<br />").replace(new RegExp("\n","g"),"<br />").replace(new RegExp('"',"g"),""),window.initToken=async()=>{try{window.ws=new WebcryptoSocket.SocketProvider({storage:await WebcryptoSocket.BrowserStorage.create()}).connect("127.0.0.1:24342").on("error",(e=>{setError(e.message)})).on("listening",(async e=>{if(!await ws.isLoggedIn()){const e=await ws.challenge();setError(`Session PIN: ${e}`),await ws.login()}await FillProviderSelectEx(selector("provider")),ws.cardReader.on("insert",(async e=>{await FillProviderSelectEx(selector("provider"))})).on("remove",(async e=>{await FillProviderSelectEx(selector("provider"))}))}))}catch(e){setError(e.message)}selector("certificate").onchange=()=>{selector("certLabel").value=selector("certificate option:selected").text},selector("provider").onchange=async()=>{try{const e=await ws.getCrypto(selector("provider").value);await e.reset(),FillItems(selector("provider").value)}catch(e){setError(e.message)}},selector("refresh").onclick=async()=>{try{if(await FillProviderSelectEx(selector("provider")),selector("provider").value){const e=await ws.getCrypto(selector("provider").value);await e.reset(),await FillItems(selector("provider").value)}}catch(e){setError(e.message)}}}})();